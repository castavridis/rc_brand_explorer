# Quickstart: Quarterly Brand Data Association

**Feature**: 004-quarterly-data-association
**For**: Developers implementing or extending this feature
**Last Updated**: 2025-11-17

## Overview

This feature associates brands from `brands.json` with quarterly brand perception metrics from CSV files. Users can view metrics for individual quarters, compare performance across quarters, and filter brands by data availability.

**Key capabilities**:
- Load and display 85+ brand metrics per quarter
- Compare brands across up to 10 quarters
- Handle sparse data (not all brands have data for all quarters)
- Case-insensitive brand name matching

## Quick Links

- **Spec**: [spec.md](spec.md) - Requirements and user scenarios
- **Data Model**: [data-model.md](data-model.md) - Entity definitions
- **Contracts**: [contracts/](contracts/) - Service interfaces
- **Research**: [research.md](research.md) - Technical decisions

## Prerequisites

- Node.js 18+ with npm
- TypeScript 5.3+
- Existing project dependencies (React 18, Vite 5, csv-parser, Commander)
- Quarterly CSV files in `/public/test-data/` (format: `YYYYQ#-Table 1.csv`)

## Setup Steps

### 1. Install Dependencies (if not already installed)

```bash
npm install
```

All required dependencies already exist in `package.json`.

### 2. Add Quarterly CSV Files

Place CSV files in `/public/test-data/`:

```
/public/test-data/
├── 2010Q1-Table 1.csv
├── 2010Q2-Table 1.csv
├── 2010Q3-Table 1.csv
└── ...
```

**CSV Format Requirements**:
- First row: Column headers (85+ columns)
- Required columns: `Brand id`, `Brand name`, `Category`, metric columns
- Metric columns: `Total_Users_pct`, `Total_Prefer_pct`, brand equity scores, perception attributes
- Empty cells allowed (will be stored as `null`)

### 3. Process Quarterly Data (Build Time)

Run the data processing script to transform CSVs → JSON:

```bash
npm run process-quarterly-data
```

This script:
1. Reads CSV files from `/public/test-data/*.csv`
2. Extracts quarter from filename (regex: `/(\d{4}Q\d)/i`)
3. Matches brands to `brands.json` (case-insensitive)
4. Outputs JSON files to `/public/assets/data/quarterly/{quarter}.json`
5. Generates index at `/public/assets/data/quarterly/index.json`

**Expected Output**:
```
Processing quarterly data...
✓ 2010Q1-Table 1.csv → 2010Q1.json (100 brands matched, 5 unmatched)
✓ 2010Q2-Table 1.csv → 2010Q2.json (98 brands matched, 7 unmatched)
...
✓ Generated index.json (10 quarters available)
Done! Processed 10 CSV files.
```

### 4. Run Development Server

```bash
npm run dev
```

Navigate to `http://localhost:5173` and open a brand detail page to see quarterly data.

## File Structure

```
/public/
├── assets/data/
│   ├── brands.json (existing)
│   └── quarterly/ (NEW - generated by script)
│       ├── index.json
│       ├── 2010Q1.json
│       ├── 2010Q2.json
│       └── ...
└── test-data/
    └── *.csv (source CSV files)

/src/
├── types/
│   ├── brand.ts (existing)
│   └── quarterlyData.ts (NEW)
├── services/
│   ├── brandLoader.ts (existing)
│   ├── quarterlyDataLoader.ts (NEW)
│   └── brandAssociationService.ts (NEW)
├── utils/
│   ├── csvParser.ts (NEW)
│   └── brandMatcher.ts (NEW)
├── components/
│   ├── QuarterlyMetrics/ (NEW)
│   ├── QuarterComparison/ (NEW)
│   └── DataAvailabilityBadge/ (NEW)
└── scripts/
    └── process-quarterly-data.ts (NEW)

/tests/
├── unit/
│   ├── services/
│   ├── utils/
│   └── components/
└── integration/
    └── quarterlyDataFlow.test.ts
```

## Key Components

### Service: quarterlyDataLoader

**Location**: `src/services/quarterlyDataLoader.ts`
**Purpose**: Load and cache quarterly JSON files

```typescript
import { quarterlyDataLoader } from './services/quarterlyDataLoader';

// Load index of available quarters
const index = await quarterlyDataLoader.loadQuarterIndex();
console.log(index.quarters); // ["2010Q1", "2010Q2", ...]

// Load specific quarter
const data = await quarterlyDataLoader.loadQuarter("2010Q1");
console.log(data.recordCount); // 100

// Check cache
if (quarterlyDataLoader.isQuarterCached("2010Q1")) {
  // Data already loaded, instant access
}
```

**Contract**: [contracts/quarterlyDataLoader.contract.ts](contracts/quarterlyDataLoader.contract.ts)

### Service: brandAssociationService

**Location**: `src/services/brandAssociationService.ts`
**Purpose**: Associate brands with quarterly data

```typescript
import { brandAssociationService } from './services/brandAssociationService';

// Get brand with all quarterly data
const brandData = await brandAssociationService.getBrandWithQuarterlyData("youtube-b42bkz");
console.log(brandData.availableQuarters); // ["2010Q1", "2010Q3"]
console.log(brandData.quarterlyData.get("2010Q1")?.Total_Users_pct); // 75.5

// Get metrics for specific quarter
const metrics = await brandAssociationService.getMetricsForQuarter("youtube-b42bkz", "2010Q1");
if (metrics) {
  console.log(metrics.Total_Prefer_pct); // 68.2
} else {
  console.log("No data for this quarter");
}

// Compare across quarters
const comparison = await brandAssociationService.compareQuarters("youtube-b42bkz", ["2010Q1", "2010Q2", "2010Q3"]);
// Returns Map with only quarters that have data
```

**Contract**: [contracts/brandAssociationService.contract.ts](contracts/brandAssociationService.contract.ts)

### Component: QuarterlyMetrics

**Location**: `src/components/QuarterlyMetrics/QuarterlyMetrics.tsx`
**Purpose**: Display metrics for a single brand across available quarters

```typescript
import { QuarterlyMetrics } from './components/QuarterlyMetrics';

function BrandDetailPage({ brandId }) {
  return (
    <div>
      {/* Existing brand info */}
      <QuarterlyMetrics brandId={brandId} />
    </div>
  );
}
```

**Features**:
- Shows all available quarters for the brand
- Groups metrics by category (awareness, perception, relationship)
- Displays "No data" for null metric values
- Accessible tables (WCAG 2.1 AA compliant)

### Component: QuarterComparison

**Location**: `src/components/QuarterComparison/QuarterComparison.tsx`
**Purpose**: Multi-quarter comparison view

```typescript
import { QuarterComparison } from './components/QuarterComparison';

function ComparisonPage({ brandId }) {
  return <QuarterComparison brandId={brandId} />;
}
```

**Features**:
- Multi-select quarter picker
- Metric selector (choose which metrics to compare)
- Side-by-side comparison table
- Difference/change calculation
- **T028**: Keyboard navigation support (Escape to close, Ctrl/Cmd+A to select all)

### Component: DataAvailabilityBadge

**Location**: `src/components/DataAvailabilityBadge/DataAvailabilityBadge.tsx`
**Purpose**: Display quarterly data availability indicator

```typescript
import { DataAvailabilityBadge } from './components/DataAvailabilityBadge';

// Show quarter count
<DataAvailabilityBadge quarterCount={5} size="small" />

// Show specific quarters
<DataAvailabilityBadge
  quarters={["2010Q1", "2010Q2", "2010Q3"]}
  variant="detailed"
  size="medium"
/>
```

**Features**:
- Compact and detailed display variants
- Shows quarter count or specific quarter names
- "No data" indicator for brands without quarterly data
- **T033**: Integrated into LogoCard (displays in card corner)

### Error Handling

**T040: Error Boundaries** - Quarterly data components are wrapped with error boundaries for graceful degradation:

```typescript
import { QuarterlyDataErrorBoundary } from './components/ErrorBoundary';

// Wrap quarterly components for automatic error handling
<QuarterlyDataErrorBoundary
  componentName="Quarterly Metrics"
  onError={(error, errorInfo) => {
    console.error('Component error:', error);
  }}
>
  <QuarterlyMetrics brandId={brandId} />
</QuarterlyDataErrorBoundary>
```

**Features**:
- Catches React errors in quarterly data components
- Displays user-friendly fallback UI
- Provides "Try Again" and "Reload Page" buttons
- Logs detailed error information to console
- Prevents entire page crash when data loading fails

## Common Tasks

### Add New Quarterly CSV File

**T042: Enhanced CSV Validation** - The processing script now validates CSV files before processing:

1. Place CSV file in `/public/test-data/` with format `YYYYQ#-*.csv`
2. Run `npm run process-quarterly-data`
3. **Review validation output**:
   ```
   Processing 2010Q1-Table 1.csv → 2010Q1.json
   ⚠️  Data validation warnings:
      - 5 rows have empty brand names (will be skipped)
      - 12 invalid metric values detected (will be stored as null)
      - Row 23: Total_Users_pct value 105.5 is outside expected range [0-100]
   ✓ Matched 106 brands
   ```
4. **Fix validation warnings** if needed:
   - Missing required columns → Add columns to CSV
   - Invalid metric values → Correct non-numeric values
   - Out-of-range percentages → Verify data accuracy
   - Empty brand names → Fill in brand names or remove rows
5. Re-run processing after fixes
6. Verify output in `/public/assets/data/quarterly/`
7. Rebuild app: `npm run build`

**Validation Checks**:
- File size warnings (files >10MB)
- Required columns present
- Empty brand name detection
- Invalid metric values (non-numeric)
- Out-of-range percentages (outside 0-100)
- Duplicate brand names

### Filter Brands by Data Availability

**T032-T036: Brand Filtering** - Users can filter the brand catalog by quarterly data:

```typescript
// The LogoGrid component now includes filter controls

// Filter brands with any quarterly data
<LogoGrid brands={brands} onBrandClick={handleClick} />
// User can check "Show only brands with quarterly data"

// Filter brands with specific quarter
// User can select quarter from dropdown (e.g., "2010Q1")
```

**Filter Features**:
- **Checkbox**: "Show only brands with quarterly data"
- **Dropdown**: Filter by specific quarter (2010Q1, 2010Q2, etc.)
- **Clear button**: Reset all filters
- **Result count**: Live update showing "Showing X of Y brands"
- **Badge display**: Each brand card shows quarter count badge
- **Performance**: Async filtering with loading indicator

### Test Data Loading

```typescript
// In browser console or test file
import { quarterlyDataLoader } from './services/quarterlyDataLoader';

const quarters = await quarterlyDataLoader.getAvailableQuarters();
console.log(`${quarters.length} quarters available`);

const data = await quarterlyDataLoader.loadQuarter("2010Q1");
console.log(`${data.recordCount} brands in 2010Q1`);
console.log(`${data.matchedBrands} matched to brands.json`);
console.log(`Unmatched brands:`, data.unmatchedBrands);
```

### Debug Brand Matching

```typescript
import { brandMatcher } from './utils/brandMatcher';

// Test case-insensitive matching
console.log(brandMatcher.matchBrand("YouTube", "youtube")); // true
console.log(brandMatcher.matchBrand("YouTube", "YouTube Inc.")); // false

// Check normalization
console.log(brandMatcher.normalizeBrandName("  YouTube  ")); // "youtube"
```

### Handle Missing Data in UI

```typescript
// Recommended pattern for displaying metrics
function MetricValue({ value }: { value: number | null }) {
  if (value === null) {
    return <span className="no-data">No data</span>;
  }
  return <span>{value.toFixed(2)}%</span>;
}

// Usage
<MetricValue value={metrics.Total_Users_pct} />
```

## Testing

### Run All Tests

```bash
npm test
```

### Run Specific Test Suite

```bash
# Unit tests
npm test -- src/services/quarterlyDataLoader.test.ts
npm test -- src/utils/brandMatcher.test.ts

# Component tests
npm test -- src/components/QuarterlyMetrics/QuarterlyMetrics.test.tsx

# Integration tests
npm test -- tests/integration/quarterlyDataFlow.test.ts
```

### Test Coverage

```bash
npm run test:coverage
```

**Target Coverage**:
- Services: 90%+ line coverage
- Utils: 95%+ line coverage (critical matching logic)
- Components: 80%+ line coverage

## Performance Monitoring

**T037: Built-in Performance Tracking** - The `quarterlyDataLoader` service automatically monitors load times and cache performance.

### Check Load Times

```typescript
// In browser console
console.time('loadQuarter');
await quarterlyDataLoader.loadQuarter("2010Q1");
console.timeEnd('loadQuarter'); // Should be <500ms

console.time('getBrandWithQuarterlyData');
await brandAssociationService.getBrandWithQuarterlyData("youtube-b42bkz");
console.timeEnd('getBrandWithQuarterlyData'); // Should be <2s (per SC-001)
```

### Monitor Cache Usage

**T039: Enhanced Cache Monitoring** - Access detailed cache statistics:

```typescript
// Get comprehensive cache statistics
const stats = quarterlyDataLoader.getCacheStats();
console.log(stats);
// Output:
// {
//   cacheSize: 5,
//   cachedQuarters: ["2010Q1", "2010Q2", "2010Q3", "2010Q4", "2011Q1"],
//   cacheHitRate: "85.2%",
//   averageLoadTime: "245ms"
// }

// Get detailed performance metrics
const metrics = quarterlyDataLoader.getPerformanceMetrics();
console.log(metrics);
// Output:
// {
//   totalLoads: 27,
//   cacheHits: 23,
//   cacheMisses: 4,
//   averageLoadTime: 245,
//   slowLoads: 0,  // Count of loads >2s
//   loadTimes: [...]
// }
```

**Automatic Warnings**: The service automatically logs warnings when load times exceed 2 seconds (SC-001 threshold):

```
⚠️ [quarterlyDataLoader] Slow quarter load detected: 2010Q1 took 2156ms (threshold: 2000ms)
```

### Preload Quarters for Better Performance

**T039: Cache Warmup** - Preload quarters to improve initial page load:

```typescript
// Preload all quarters on app initialization
await quarterlyDataLoader.preloadQuarters(["2010Q1", "2010Q2", "2010Q3"]);

// The quarters are now cached, subsequent access is instant
const data = await quarterlyDataLoader.loadQuarter("2010Q1"); // <5ms from cache
```

## Troubleshooting

### Issue: "Quarter data not found"

**Cause**: JSON file missing in `/public/assets/data/quarterly/`
**Solution**: Run `npm run process-quarterly-data` to regenerate files

### Issue: "Brand not found"

**Cause**: Brand ID doesn't exist in `brands.json`
**Solution**: Verify brand ID is correct, check `brands.json` for valid IDs

### Issue: Unmatched brands in CSV

**Cause**: Brand name in CSV doesn't match any brand in `brands.json` (case-insensitive)
**Solution**:
1. Check `unmatchedBrands` array in generated JSON file
2. Verify spelling in CSV vs `brands.json`
3. Add missing brands to `brands.json` or update CSV names

### Issue: Metrics showing as "No data"

**Cause**: CSV cells are empty (null values in JSON)
**Solution**: This is expected behavior (per FR-007). Display "No data" in UI (per SC-006).

### Issue: Slow loading (>2 seconds)

**Cause**: Loading all quarters at once, or large CSV files
**Solution**:
1. Use lazy loading (only load quarters when needed)
2. Check network tab for concurrent requests
3. Verify caching is working (`isQuarterCached()`)
4. Consider preloading index on app init

## Next Steps

After completing this feature:

1. **Run `/speckit.tasks`** to generate implementation tasks
2. **Run `/speckit.implement`** to execute tasks in dependency order
3. **Test user stories** against acceptance scenarios in spec.md
4. **Verify success criteria** (SC-001 through SC-006)
5. **Run accessibility audit** (WCAG 2.1 AA compliance)

## Additional Resources

- **Spec Document**: [spec.md](spec.md) - Full requirements
- **Constitution**: `/.specify/memory/constitution.md` - Project principles
- **CLAUDE.md**: `/CLAUDE.md` - Project guidelines and active technologies
- **Existing Import Script**: `src/scripts/import-brands.ts` - Reference for CSV processing patterns

## Support

For questions or issues:
1. Check spec.md for requirement clarifications
2. Review research.md for technical decision rationale
3. Consult contracts/ for service API details
4. Review existing `import-brands.ts` script for CSV parsing examples
